// SPDX-FileCopyrightText: 2022-present Intel Corporation
//
// SPDX-License-Identifier: Apache-2.0

package atom

import (
	"context"
	"github.com/atomix/sdk/pkg/driver"
	"github.com/atomix/sdk/pkg/plugin"
	"google.golang.org/grpc"
)

const pluginSymbol = "Atom"

type Repository plugin.Repository[Type]

func NewRepository(opts ...RepoOption) Repository {
	var options RepoOptions
	options.apply(opts...)
	cache := plugin.NewCache(plugin.WithPath(options.Path))
	return plugin.NewRepository[Type](cache,
		plugin.WithSymbol(pluginSymbol),
		plugin.WithDownloader(options.Downloader))
}

type Registrar[T Atom] func(*grpc.Server, *Service[T], *Registry[T])

func New[T Atom](resolver ClientResolver[T], registrar Registrar[T]) Type {
	return &atomType[T]{
		resolver:  resolver,
		registrar: registrar,
		registry:  NewRegistry[T](),
	}
}

type Type interface {
	Register(server *grpc.Server, connector Connector)
}

type atomType[T Atom] struct {
	resolver  ClientResolver[T]
	registrar Registrar[T]
	registry  *Registry[T]
}

func (a *atomType[T]) Register(server *grpc.Server, connector Connector) {
	a.registrar(server, NewService[T](connector, a.resolver, a.registry), a.registry)
}

type Atom interface {
	Close(ctx context.Context) error
}

type ClientResolver[T Atom] func(client driver.Client) (*Client[T], bool)

// NewClient creates a new client for the given atom type
func NewClient[T Atom](getter func(ctx context.Context, name string) (T, error)) *Client[T] {
	return &Client[T]{
		getter: getter,
	}
}

type Client[T Atom] struct {
	getter func(ctx context.Context, name string) (T, error)
}

func (c *Client[T]) GetAtom(ctx context.Context, name string) (T, error) {
	return c.getter(ctx, name)
}
